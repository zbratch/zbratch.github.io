<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Field Feedback Form</title>
  <style>
    :root { --gap:14px; --radius:14px; --bg:#0b0c0f; --card:#12141a; --muted:#8b93a6; --text:#e9ecf1; --accent:#4da3ff; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { position: sticky; top:0; z-index: 2; background: linear-gradient(180deg, rgba(11,12,15,.95), rgba(11,12,15,.75)); backdrop-filter: blur(6px); border-bottom: 1px solid #1b1f2a; }
    header .wrap { display:flex; align-items:center; gap: var(--gap); padding: 12px 16px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }

    .container { padding: 16px; }
    .card { background: var(--card); border: 1px solid #1b1f2a; border-radius: var(--radius); padding: 14px; box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    .q { margin-bottom: 16px; }
    .q h2 { font-size: 16px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 13px; }

    .row { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }

    .stars { display: inline-flex; gap: 6px; }
    .star { background: none; border: 0; font-size: 22px; line-height: 1; cursor: pointer; color: #4c546a; transition: transform .05s ease; }
    .star.on { color: #ffd452; text-shadow: 0 0 6px rgba(255,212,82,.35); }
    .star:active { transform: scale(.9); }

    textarea { width: 100%; min-height: 88px; padding: 10px 12px; border-radius: 10px; border: 1px solid #293043; resize: vertical; background:#0f1117; color: var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }

    details { border: 1px solid #23293a; border-radius: 10px; overflow: hidden; }
    details + details { margin-top: 8px; }
    summary { list-style: none; cursor: pointer; padding: 10px 12px; background: #0f121a; font-weight: 600; }
    summary::-webkit-details-marker { display: none; }

    .thumbs { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:8px; padding: 10px; }
    .thumb { position: relative; border-radius: 10px; overflow: hidden; border: 1px solid #2a3045; }
    .thumb img { display:block; width: 100%; height: 100px; object-fit: cover; }
    .thumb .del { position:absolute; top:6px; right:6px; border:0; background: rgba(0,0,0,.55); color:#fff; border-radius: 50%; width:26px; height:26px; line-height:26px; text-align:center; cursor:pointer; }

    .controls { position: sticky; bottom: 0; z-index: 2; background: linear-gradient(0deg, rgba(11,12,15,.98), rgba(11,12,15,.88)); padding: 10px 16px; border-top: 1px solid #1b1f2a; display:flex; flex-wrap: wrap; gap: 8px; }
    .btn { appearance:none; border: 1px solid #2a75ff55; background: #1a2540; color:#e8f0ff; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #111522; border-color: #26314d; color: #d7dceb; }
    .btn:active { transform: translateY(1px); }

    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; font-size: 12px; border-radius: 999px; border:1px solid #27314d; background:#0f1320; }

    .grid { display: grid; gap: 14px; }
@media (min-width: 760px) { .grid { grid-template-columns: 1fr 1fr 1fr; } }
.hidden { display:none !important; }
/* Section wrappers */
.section { border: 1px solid #1b1f2a; border-radius: var(--radius); overflow: hidden; background: #0f121a; }
.section + .section { margin-top: 12px; }
.section > summary { list-style: none; cursor: pointer; font-weight: 700; padding: 12px 14px; background: #0f121a; border-bottom: 1px solid #1b1f2a; }
.section > summary::-webkit-details-marker { display:none; }
.section-body { padding: 12px; background: transparent; }

/* --- Compact meta bar styles --- */
#meta { padding: 10px 12px; }
.meta-grid { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
.field { flex: 1 1 220px; min-width: 200px; }
.label { display:block; margin:0 0 6px; color: var(--muted); font-size: 13px; }
.input { width:100%; height:42px; padding:10px 12px; border-radius:10px; border:1px solid #293043; background:#0f1117; color: var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
input[type="date"].input { appearance:none; -webkit-appearance:none; }
input[type="date"].input::-webkit-calendar-picker-indicator { filter: invert(0.8); opacity: 0.7; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Field Feedback Form</h1>
    <span class="chip" id="saveState">Unsaved</span>
  </div>
</header>

<div class="container">
  <!-- Meta: Project # / Date / Surveyor -->
  <div class="card" id="meta">
    <div class="meta-grid">
      <div class="field">
        <label class="label" for="project">Project #</label>
        <input class="input" id="project" placeholder="e.g., 234001" />
      </div>
      <div class="field">
        <label class="label" for="when">Date</label>
        <input class="input" id="when" type="date" />
      </div>
      <div class="field">
        <label class="label" for="who">Surveyor name</label>
        <input class="input" id="who" placeholder="Your name" />
      </div>
    </div>
  </div>
    <div>
      <label class="muted" for="when">Date</label><br/>
      <input id="when" type="date" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #293043; background:#0f1117; color:var(--text);"/>
    </div>
    <div>
      <label class="muted" for="who">Surveyor name</label><br/>
      <input id="who" placeholder="Your name" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #293043; background:#0f1117; color:var(--text);"/>
    </div>
  </div>

  <!-- Sections mount (generated from Excel) -->
  <div id="sectionsMount"></div>
</div>

<div class="controls">
  <button class="btn" id="exportZip">Download .zip</button>
  <button class="btn" id="exportHTML">Download single .html</button>
  <button class="btn secondary" id="share">Share…</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const mount = document.getElementById('sectionsMount');

function renderSections(sections){
  mount.innerHTML = '';
  sections.forEach(sec => {
    const det = document.createElement('details');
    det.className = 'card';
    det.open = true;
    det.innerHTML = `<summary>${sec.title}</summary>`;

    (sec.questions||[]).forEach(q => {
      const block = document.createElement('div');
      block.className = 'q';
      block.dataset.id = q.id;
      block.innerHTML = `
        <h3>${q.text}</h3>
        <div class="stars" aria-label="star rating" role="radiogroup">
          ${[1,2,3,4,5].map(i=>`<button class="star" data-v="${i}" aria-label="${i} stars">☆</button>`).join('')}
        </div>
        <textarea placeholder="Add comments..."></textarea>
        <input type="file" accept="image/*" multiple>
        <details>
          <summary>Reference (A)</summary>
          <div class="thumbs">
            ${q.refA.filter(Boolean).slice(0,2).map(src=>`<div class='thumb'><img src='${src}' alt='A'></div>`).join('') || '<div class="muted" style="padding:10px;">No images</div>'}
          </div>
        </details>
        <details>
          <summary>Reference (B)</summary>
          <div class="thumbs">
            ${q.refB.filter(Boolean).slice(0,2).map(src=>`<div class='thumb'><img src='${src}' alt='B'></div>`).join('') || '<div class="muted" style="padding:10px;">No images</div>'}
          </div>
        </details>
      `;
      det.appendChild(block);
    });

    mount.appendChild(det);
  });

  // Wire up star widgets for new DOM
  mount.querySelectorAll('.stars').forEach(group => {
    const btns = group.querySelectorAll('.star');
    btns.forEach(btn => btn.addEventListener('click', () => {
      btns.forEach(b => b.textContent = '☆');
      for(let i=0;i<Number(btn.dataset.v);i++){ btns[i].textContent = '★'; }
    }));
  });
}

async function loadExcelFromUrl(url){
  try{
    const res = await fetch(url);
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'});
    const sheetName = wb.SheetNames.find(n=>n.toLowerCase()==='questions') || wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {defval:''});
    const groups = new Map();
    rows.forEach((r,i)=>{
      const section = String(r.Section||'Untitled').trim();
      const sorder = Number(r.SectionOrder||0)||0;
      const id = String(r.QuestionID||`q_${i+1}`).trim();
      const text = String(r.QuestionText||'').trim();
      const qorder = Number(r.QOrder||0)||0;
      const refA = [r.RefA1,r.RefA2].map(v=>String(v||'').trim()).filter(Boolean);
      const refB = [r.RefB1,r.RefB2].map(v=>String(v||'').trim()).filter(Boolean);
      if(!groups.has(section)) groups.set(section,{title:section,order:sorder,questions:[]});
      groups.get(section).questions.push({id,text,order:qorder,refA,refB});
    });
    const sections = Array.from(groups.values())
      .sort((a,b)=>a.order-b.order)
      .map(sec=>({title:sec.title,questions:sec.questions.sort((a,b)=>a.order-b.order)}));
    renderSections(sections);
  }catch(e){
    console.error('Failed to load Excel:',e);
    mount.innerHTML = '<div class="card">Could not load questionnaire.</div>';
  }
}

// Auto-load Excel file from fixed path in your repo
// Change this path to match your repo structure (e.g., 'data/FormTemplate.xlsx')
loadExcelFromUrl('FormTemplate.xlsx');
</script>
<script>
// --- Auto-load Excel from fixed path ---
(function(){
  const FIXED_XLSX_PATH = 'QuestionsList.xlsx'; // <-- change this path
  if (!window.fetch) return; // very old browsers
  async function autoload(){
    try {
      const res = await fetch(FIXED_XLSX_PATH, { cache: 'no-store' });
      if(!res.ok) return;
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab, { type: 'array' });
      const sheetName = wb.SheetNames.find(n => n.toLowerCase() === 'questions') || wb.SheetNames[0];
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: '' });
      const groups = new Map();
      rows.forEach((r,i) => {
        const section = String(r.Section || 'Untitled').trim();
        const sorder = Number(r.SectionOrder || 0) || 0;
        const id = String(r.QuestionID || `q_${i+1}`).trim();
        const text = String(r.QuestionText || '').trim();
        const qorder = Number(r.QOrder || 0) || 0;
        const refA = [r.RefA1, r.RefA2].map(v => String(v||'').trim()).filter(Boolean);
        const refB = [r.RefB1, r.RefB2].map(v => String(v||'').trim()).filter(Boolean);
        if(!groups.has(section)) groups.set(section, { title: section, order: sorder, questions: [] });
        groups.get(section).questions.push({ id, text, order: qorder, refA, refB });
      });
      const sections = Array.from(groups.values())
        .sort((a,b)=>a.order-b.order)
        .map(sec => ({ title: sec.title, questions: sec.questions.sort((a,b)=>a.order-b.order).map(q => ({ id:q.id, text:q.text, refA:q.refA, refB:q.refB })) }));
      if (typeof renderSections === 'function') {
        renderSections(sections);
      }
    } catch (e) { console.warn('Auto-load Excel failed:', e); }
  }
  // Try once after page load (give DOM a moment to set up)
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(autoload, 200);
  } else {
    window.addEventListener('DOMContentLoaded', () => setTimeout(autoload, 200));
  }
})();
</script>
</body>
</html>
