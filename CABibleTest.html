<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Field Feedback Form</title>
  <style>
    :root { --gap:14px; --radius:14px; --bg:#0b0c0f; --card:#12141a; --muted:#8b93a6; --text:#e9ecf1; --accent:#4da3ff; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { position: sticky; top:0; z-index: 2; background: linear-gradient(180deg, rgba(11,12,15,.95), rgba(11,12,15,.75)); backdrop-filter: blur(6px); border-bottom: 1px solid #1b1f2a; }
    header .wrap { display:flex; align-items:center; gap: var(--gap); padding: 12px 16px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }

    .container { padding: 16px; }
    .card { background: var(--card); border: 1px solid #1b1f2a; border-radius: var(--radius); padding: 14px; box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    .q { margin-bottom: 16px; }
    .q h2 { font-size: 16px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 13px; }

    .row { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }

    .stars { display: inline-flex; gap: 6px; }
    .star { background: none; border: 0; font-size: 22px; line-height: 1; cursor: pointer; color: #4c546a; transition: transform .05s ease; }
    .star.on { color: #ffd452; text-shadow: 0 0 6px rgba(255,212,82,.35); }
    .star:active { transform: scale(.9); }

    textarea, input[type="text"], input[type="date"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #293043; background:#0f1117; color: var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
    textarea { min-height: 88px; resize: vertical; }

    details { border: 1px solid #23293a; border-radius: 10px; overflow: hidden; }
    details + details { margin-top: 8px; }
    summary { list-style: none; cursor: pointer; padding: 10px 12px; background: #0f121a; font-weight: 600; }
    summary::-webkit-details-marker { display: none; }

    .thumbs { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:8px; padding: 10px; }
    .thumb { position: relative; border-radius: 10px; overflow: hidden; border: 1px solid #2a3045; }
    .thumb img { display:block; width: 100%; height: 100px; object-fit: cover; }
    .thumb .del { position:absolute; top:6px; right:6px; border:0; background: rgba(0,0,0,.55); color:#fff; border-radius: 50%; width:26px; height:26px; line-height:26px; text-align:center; cursor:pointer; }

    .controls { position: sticky; bottom: 0; z-index: 2; background: linear-gradient(0deg, rgba(11,12,15,.98), rgba(11,12,15,.88)); padding: 10px 16px; border-top: 1px solid #1b1f2a; display:flex; flex-wrap: wrap; gap: 8px; }
    .btn { appearance:none; border: 1px solid #2a75ff55; background: #1a2540; color:#e8f0ff; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #111522; border-color: #26314d; color: #d7dceb; }
    .btn:active { transform: translateY(1px); }

    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; font-size: 12px; border-radius: 999px; border:1px solid #27314d; background:#0f1320; }

    .grid { display: grid; gap: 14px; }
    @media (min-width: 760px) { .grid { grid-template-columns: 1fr 1fr 1fr; } }

    .hidden { display:none !important; }

    /* Section wrappers (collapsible by default) */
    .section { border: 1px solid #1b1f2a; border-radius: var(--radius); overflow: hidden; background: #0f121a; }
    .section + .section { margin-top: 12px; }
    .section > summary { list-style: none; cursor: pointer; font-weight: 700; padding: 12px 14px; background: #0f121a; border-bottom: 1px solid #1b1f2a; }
    .section > summary::-webkit-details-marker { display:none; }
    .section-body { padding: 12px; background: transparent; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Field Feedback Form</h1>
    <span class="chip" id="saveState">Unsaved</span>
  </div>
</header>

<div class="container">
  <!-- Meta: Project # / Date / Surveyor -->
  <div class="card grid" id="meta">
    <div>
      <label class="muted" for="project">Project #</label><br/>
      <input id="project" placeholder="e.g., 234001" />
    </div>
    <div>
      <label class="muted" for="when">Date</label><br/>
      <input id="when" type="date" />
    </div>
    <div>
      <label class="muted" for="who">Surveyor name</label><br/>
      <input id="who" placeholder="Your name" />
    </div>
  </div>

  <!-- Config Loader (manual override) -->
  <div class="card">
    <strong>Load form from Excel</strong>
    <p class="muted">Upload a .xlsx with sheet <code>Questions</code> and columns: <code>Section, SectionOrder, QuestionID, QuestionText, QOrder, RefA1, RefA2, RefB1, RefB2</code>.</p>
    <input id="cfgXlsx" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
  </div>

  <!-- Sections + Questions mount -->
  <div id="sections"></div>
</div>

<div class="controls">
  <button class="btn" id="exportZip">Download .zip</button>
  <button class="btn" id="exportHTML">Download single .html</button>
  <button class="btn secondary" id="share">Share…</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// Fixed Excel path (change this to match your repo)
const FIXED_XLSX_PATH = 'QuestionsList.xlsx';

// ------- STATE
const state = { project:'', who:'', when:'', items: {} };
const $ = sel => document.querySelector(sel);

function markSaved(){ $('#saveState').textContent='Saved'; setTimeout(()=>$('#saveState').textContent='Up to date',800); }
function markDirty(){ $('#saveState').textContent='Saving…'; setTimeout(()=>markSaved(),200); }

// ------- BUILDERS
function thumbHTML(src){ return `<div class="thumb"><img src="${src}" alt="" /></div>`; }

function buildThumbFromDataURL(dataUrl){ const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img alt="photo" src="${dataUrl}"><button class="del" title="Remove">×</button>`; d.querySelector('.del').addEventListener('click',()=>{ for(const id in state.items){ const idx=state.items[id].photos.findIndex(p=>p.dataUrl===dataUrl); if(idx!==-1){ state.items[id].photos.splice(idx,1); break; } } d.remove(); markDirty(); }); return d; }

function suggestPhotoName(qid, original){ const safe=original.replace(/[^a-z0-9_.-]+/gi,'_').replace(/_+/g,'_'); const count=state.items[qid].photos?.length||0; const ext=(safe.includes('.')? safe.split('.').pop():'jpg'); return `${qid}_${String(count+1).padStart(2,'0')}.${ext}`; }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

function buildQuestion(q){
  const wrap = document.createElement('section');
  wrap.className='card q'; wrap.dataset.id=q.id;
  wrap.innerHTML = `
    <h2>${q.text}</h2>

    <!-- References FIRST -->
    <details style="margin-top:6px;">
      <summary>Reference images (A)</summary>
      <div class="thumbs" data-role="refA">${(q.refA||[]).map(src=>thumbHTML(src)).join('')}</div>
    </details>
    <details>
      <summary>Reference images (B)</summary>
      <div class="thumbs" data-role="refB">${(q.refB||[]).map(src=>thumbHTML(src)).join('')}</div>
    </details>

    <!-- Rating with label 'Rating:' -->
    <div class="row" style="margin-top:10px;" aria-label="Star rating" role="group">
      <span class="muted"><strong>Rating:</strong></span>
      <div class="stars" role="radiogroup" aria-label="Rating for ${q.text}">
        ${[1,2,3,4,5].map(i=>`<button class=\"star\" data-v=\"${i}\" aria-label=\"${i} star\" aria-checked=\"false\" role=\"radio\">☆</button>`).join('')}
      </div>
      <span class="muted" data-role="ratingStatus"></span>
    </div>

    <!-- User inputs AFTER references -->
    <div style="margin-top:10px;">
      <label class="muted" for="c-${q.id}">Comments</label>
      <textarea id="c-${q.id}" placeholder="Add your notes…"></textarea>
    </div>

    <div style="margin-top:10px;">
      <div class="row" style="justify-content:space-between;">
        <label class="muted">Your photos</label>
        <label class="btn secondary" style="padding:6px 10px; font-size:12px;" for="f-${q.id}">Add photos</label>
      </div>
      <input id="f-${q.id}" type="file" accept="image/*" capture="environment" multiple class="hidden" />
      <div class="thumbs" data-role="userPhotos"></div>
    </div>`;

  state.items[q.id] ||= { rating:0, comment:'', photos:[] };

  const stars = wrap.querySelectorAll('.star');
  const status = wrap.querySelector('[data-role=ratingStatus]');
  function paint(n){ stars.forEach((b,i)=>{ const on=i<n; b.textContent = on?'★':'☆'; b.classList.toggle('on',on); b.setAttribute('aria-checked', on && i===n-1 ? 'true':'false'); }); status.textContent = n? `${n}/5`:''; }
  stars.forEach(btn=>btn.addEventListener('click',()=>{ state.items[q.id].rating=Number(btn.dataset.v); paint(state.items[q.id].rating); markDirty(); }));

  const ta = wrap.querySelector('textarea'); ta.value = state.items[q.id].comment || ''; ta.addEventListener('input',()=>{ state.items[q.id].comment=ta.value; markDirty(); });

  const input = wrap.querySelector(`#f-${q.id}`); const gallery = wrap.querySelector('[data-role=userPhotos]');
  input.addEventListener('change', async ()=>{
    const files = Array.from(input.files||[]);
    for(const f of files){ const dataUrl = await fileToDataURL(f); state.items[q.id].photos.push({ name:suggestPhotoName(q.id,f.name), type:f.type, dataUrl }); gallery.appendChild(buildThumbFromDataURL(dataUrl)); }
    input.value=''; markDirty();
  });

  if(state.items[q.id].photos?.length){ state.items[q.id].photos.forEach(p=>gallery.appendChild(buildThumbFromDataURL(p.dataUrl))); }
  paint(state.items[q.id].rating||0);
  return wrap;
}

function buildSection(sec){
  const det = document.createElement('details'); det.className='section'; det.open = false; // start collapsed
  det.innerHTML = `<summary>${sec.title}</summary>`;
  const inner = document.createElement('div'); inner.className='section-body';
  (sec.questions||[]).forEach(q=> inner.appendChild(buildQuestion(q)));
  det.appendChild(inner); return det;
}

// ------- RENDER
function renderSections(sections){
  const mount = document.getElementById('sections');
  mount.innerHTML = '';
  sections.forEach(sec => mount.appendChild(buildSection(sec)));
}

// ------- EXPORTS (kept minimal for this version)
function gatherExportPayload(){ return { meta:{ project:$('#project').value.trim(), who:$('#who').value.trim(), when: $('#when').value || new Date().toISOString().slice(0,10) }, items: state.items }; }

$('#exportHTML').addEventListener('click', ()=>{
  const data = gatherExportPayload();
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  saveAs(blob, `feedback_${Date.now()}.json`);
});

$('#exportZip').addEventListener('click', ()=>{ alert('ZIP export not wired in this slim file yet—use the earlier full export version or ask me to merge them.'); });
$('#share').addEventListener('click', ()=>{ alert('Share not wired in this slim file yet—can add back easily.'); });

// ------- EXCEL LOADING
async function parseWorkbook(ab){
  const wb = XLSX.read(ab, { type: 'array' });
  const sheetName = wb.SheetNames.find(n => n.toLowerCase() === 'questions') || wb.SheetNames[0];
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: '' });
  const groups = new Map();
  rows.forEach((r,i) => {
    const section = String(r.Section || 'Untitled').trim();
    const sorder = Number(r.SectionOrder || 0) || 0;
    const id = String(r.QuestionID || `q_${i+1}`).trim();
    const text = String(r.QuestionText || '').trim();
    const qorder = Number(r.QOrder || 0) || 0;
    const refA = [r.RefA1, r.RefA2].map(v => String(v||'').trim()).filter(Boolean);
    const refB = [r.RefB1, r.RefB2].map(v => String(v||'').trim()).filter(Boolean);
    if(!groups.has(section)) groups.set(section, { title: section, order: sorder, questions: [] });
    groups.get(section).questions.push({ id, text, order: qorder, refA, refB });
  });
  const sections = Array.from(groups.values())
    .sort((a,b)=>a.order-b.order)
    .map(sec => ({ title: sec.title, questions: sec.questions.sort((a,b)=>a.order-b.order).map(q => ({ id:q.id, text:q.text, refA:q.refA, refB:q.refB })) }));
  renderSections(sections);
}

async function loadExcelFromUrl(url){
  const res = await fetch(new URL(url, document.baseURI), { cache: 'no-store' });
  if(!res.ok) throw new Error(`Failed to fetch Excel at ${url}`);
  const ab = await res.arrayBuffer();
  await parseWorkbook(ab);
}

// Manual upload override
const inputXlsx = document.getElementById('cfgXlsx');
inputXlsx.addEventListener('change', async () => {
  const file = inputXlsx.files?.[0]; if(!file) return;
  const ab = await file.arrayBuffer(); await parseWorkbook(ab);
});

// Auto-load from fixed path on startup
loadExcelFromUrl(FIXED_XLSX_PATH).catch(err => console.warn('Auto-load failed:', err));

// Meta events
$('#project').addEventListener('input', ()=>{ state.project=$('#project').value; markDirty(); });
$('#who').addEventListener('input', ()=>{ state.who=$('#who').value; markDirty(); });
$('#when').addEventListener('change', ()=>{ state.when=$('#when').value; markDirty(); });
</script>
</body>
</html>
