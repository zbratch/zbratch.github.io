<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Field Feedback Form</title>
  <style>
    :root { --gap:14px; --radius:14px; --bg:#0b0c0f; --card:#12141a; --muted:#8b93a6; --text:#e9ecf1; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { position: sticky; top:0; z-index: 2; background: linear-gradient(180deg, rgba(11,12,15,.95), rgba(11,12,15,.75)); backdrop-filter: blur(6px); border-bottom: 1px solid #1b1f2a; }
    header .wrap { display:flex; align-items:center; gap: var(--gap); padding: 12px 16px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }

    .container { padding: 16px; }
    .card { background: var(--card); border: 1px solid #1b1f2a; border-radius: var(--radius); padding: 14px; box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    .hidden { display: none !important; }

    /* Meta row tidy styles */
    #meta { padding: 10px 12px; }
    .meta-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; align-items: end; }
    .field { min-width: 0; }
    .label { display:block; margin:0 0 6px; color: var(--muted); font-size: 13px; }
    .input { width:100%; height:42px; padding:10px 12px; border-radius:10px; border:1px solid #293043; background:#0f1117; color: var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
    input[type="date"].input { appearance:none; -webkit-appearance:none; }
    input[type="date"].input::-webkit-calendar-picker-indicator { filter: invert(0.8); opacity: 0.7; }

    /* Sections (collapsible) */
    .section { border: 1px solid #1b1f2a; border-radius: var(--radius); overflow: hidden; background: #0f121a; }
    .section + .section { margin-top: 12px; }
    .section > summary { list-style: none; cursor: pointer; font-weight: 700; padding: 12px 14px; background: #0f121a; border-bottom: 1px solid #1b1f2a; display:flex; align-items:center; justify-content:space-between; }
    .section > summary:hover { background:#121629; }
    .section > summary:focus-visible { outline:2px solid #4da3ff66; outline-offset:2px; border-radius:10px; }
    .section > summary .chev { font-size: 14px; opacity: .8; transition: transform .15s ease; }
    details.section[open] > summary .chev { transform: rotate(180deg); }
    .section-body { padding: 12px; }

    .q { margin-bottom: 16px; }
    .q h2 { font-size: 16px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 13px; }

    .row { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }

    .stars { display: inline-flex; gap: 6px; }
    .star { background: none; border: 0; font-size: 22px; line-height: 1; cursor: pointer; color: #4c546a; transition: transform .05s ease; }
    .star.on { color: #ffd452; text-shadow: 0 0 6px rgba(255,212,82,.35); }
    .star:active { transform: scale(.9); }

    textarea { width: 100%; min-height: 88px; padding: 10px 12px; border-radius: 10px; border: 1px solid #293043; resize: vertical; background:#0f1117; color: var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }

    details { border: 1px solid #23293a; border-radius: 10px; overflow: hidden; }
    details + details { margin-top: 8px; }
    summary { list-style: none; cursor: pointer; padding: 10px 12px; background: #0f121a; font-weight: 600; }
    summary::-webkit-details-marker { display: none; }

    /* Thumbs grid */
    .thumbs { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:8px; padding: 10px; }
    .thumb { position: relative; border-radius: 10px; overflow: hidden; border: 1px solid #2a3045; }
    .thumb img { display:block; width: 100%; height: 100px; object-fit: cover; }

    /* Controls */
    .controls { position: sticky; bottom: 0; z-index: 2; background: linear-gradient(0deg, rgba(11,12,15,.98), rgba(11,12,15,.88)); padding: 10px 16px; border-top: 1px solid #1b1f2a; display:flex; flex-wrap: wrap; gap: 8px; }
    .btn { appearance:none; border: 1px solid #2a75ff55; background: #1a2540; color:#e8f0ff; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #111522; border-color: #26314d; color: #d7dceb; }

    /* Chevrons for inner reference image dropdowns */
    details.collapsible > summary { display:flex; align-items:center; justify-content:space-between; }
    details.collapsible > summary .chev { font-size:14px; opacity:.8; transition:transform .15s ease; }
    details.collapsible[open] > summary .chev { transform: rotate(180deg); }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Field Feedback Form</h1>
    <span class="muted" id="saveState">Up to date</span>
  </div>
</header>

<div class="container">
  <!-- Meta: Project # / Date / Surveyor -->
  <div class="card" id="meta">
    <div class="meta-row">
      <div class="field">
        <label class="label" for="project">Project #</label>
        <input class="input" id="project" placeholder="e.g., 234001" />
      </div>
      <div class="field">
        <label class="label" for="when">Date</label>
        <input class="input" id="when" type="date" />
      </div>
      <div class="field">
        <label class="label" for="who">Surveyor name</label>
        <input class="input" id="who" placeholder="Your name" />
      </div>
    </div>
  </div>

  <!-- Sections + Questions mount -->
  <div id="sections"></div>
</div>

<div class="controls">
  <button class="btn" id="exportPDF">Download PDF</button>
  <button class="btn" id="exportJSON">Download JSON</button>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
  // ====== App state ======
  const state = { project:'', who:'', when:'', items: {} };
  let CURRENT_SECTIONS = [];
  const $ = sel => document.querySelector(sel);

  function markSaved(){ $('#saveState').textContent='Up to date'; }
  function markDirty(){ $('#saveState').textContent='Saving…'; setTimeout(markSaved,250); }

  // ====== Helpers / builders ======
  function thumbHTML(src){ return '<div class="thumb"><img src="'+src+'" alt=""></div>'; }
  function buildThumbFromDataURL(dataUrl){ const d=document.createElement('div'); d.className='thumb'; d.innerHTML='<img alt="photo" src="'+dataUrl+'">'; return d; }
  function suggestPhotoName(qid, original){ const safe=String(original||'').replace(/[^a-z0-9_.-]+/gi,'_').replace(/_+/g,'_'); const count=state.items[qid].photos?.length||0; const ext=(safe.includes('.')? safe.split('.').pop():'jpg'); return qid+'_'+String(count+1).padStart(2,'0')+'.'+ext; }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

  function buildQuestion(q){
    const wrap = document.createElement('section');
    wrap.className='card q'; wrap.dataset.id=q.id;
    wrap.innerHTML = `
      <h2>${q.text}</h2>

      <!-- References FIRST -->
      <details class="collapsible ref">
        <summary><span>Good Reference images</span><span class="chev" aria-hidden="true">▾</span></summary>
        <div class="thumbs" data-role="refA">${(q.refA||[]).map(src=>thumbHTML(src)).join('')}</div>
      </details>
      <details class="collapsible ref">
        <summary><span>Bad Reference images</span><span class="chev" aria-hidden="true">▾</span></summary>
        <div class="thumbs" data-role="refB">${(q.refB||[]).map(src=>thumbHTML(src)).join('')}</div>
      </details>

      <!-- Rating with label 'Rating:' -->
      <div class="row" style="margin-top:10px;" aria-label="Star rating" role="group">
        <span class="muted"><strong>Rating:</strong></span>
        <div class="stars" role="radiogroup" aria-label="Rating for ${q.text}">
          ${[1,2,3,4,5].map(i=>`<button class="star" data-v="${i}" aria-label="${i} star" aria-checked="false" role="radio">☆</button>`).join('')}
        </div>
        <span class="muted" data-role="ratingStatus"></span>
      </div>

      <!-- User inputs AFTER references -->
      <div style="margin-top:10px;">
        <label class="muted" for="c-${q.id}">Comments</label>
        <textarea id="c-${q.id}" placeholder="Add your notes…"></textarea>
      </div>

      <div style="margin-top:10px;">
        <div class="row" style="justify-content:space-between;">
          <label class="muted">Your photos</label>
          <label class="btn secondary" style="padding:6px 10px; font-size:12px;" for="f-${q.id}">Add photos</label>
        </div>
        <input id="f-${q.id}" type="file" accept="image/*" capture="environment" multiple class="hidden" />
        <div class="thumbs" data-role="userPhotos"></div>
      </div>`;
    // init state
    if(!state.items[q.id]) state.items[q.id] = { rating:0, comment:'', photos:[] };

    // rating
    const stars = wrap.querySelectorAll('.star');
    const status = wrap.querySelector('[data-role=ratingStatus]');
    function paint(n){
      stars.forEach((b,i)=>{
        const on=i<n;
        b.textContent = on?'★':'☆';
        b.classList.toggle('on',on);
        b.setAttribute('aria-checked', on && i===n-1 ? 'true':'false');
      });
      status.textContent = n? (n+'/5'):'';
    }
    stars.forEach(btn=>btn.addEventListener('click',()=>{
      state.items[q.id].rating=Number(btn.dataset.v);
      paint(state.items[q.id].rating);
      markDirty();
    }));

    // comment
    const ta = wrap.querySelector('textarea'); 
    ta.value = state.items[q.id].comment || '';
    ta.addEventListener('input',()=>{ state.items[q.id].comment=ta.value; markDirty(); });

    // photos
    const input = wrap.querySelector('#f-'+q.id); 
    const gallery = wrap.querySelector('[data-role=userPhotos]');
    input.addEventListener('change', async ()=>{
      const files = Array.from(input.files||[]);
      for(const f of files){
        const dataUrl = await fileToDataURL(f);
        state.items[q.id].photos.push({ name:suggestPhotoName(q.id,f.name), type:f.type, dataUrl });
        gallery.appendChild(buildThumbFromDataURL(dataUrl));
      }
      input.value=''; markDirty();
    });
    if(state.items[q.id].photos?.length){
      state.items[q.id].photos.forEach(p=>gallery.appendChild(buildThumbFromDataURL(p.dataUrl)));
    }
    paint(state.items[q.id].rating||0);

    // ensure inner reference <details> start closed
    wrap.querySelectorAll('details').forEach(d=> d.removeAttribute('open'));
    return wrap;
  }

  function buildSection(sec){
    const det = document.createElement('details'); 
    det.className='section'; 
    det.removeAttribute('open'); // start collapsed
    det.innerHTML = `<summary><span class="summary-text">${sec.title}</span><span class="chev" aria-hidden="true">▾</span></summary>`;
    const inner = document.createElement('div'); 
    inner.className='section-body';
    (sec.questions || []).forEach(q=> inner.appendChild(buildQuestion(q)));
    det.appendChild(inner); 
    return det;
  }

  function renderSections(sections){
    const mount = document.getElementById('sections');
    mount.innerHTML = '';
    CURRENT_SECTIONS = sections || [];
    sections.forEach(sec => mount.appendChild(buildSection(sec)));
    // ensure all sections collapsed after render
    requestAnimationFrame(()=> document.querySelectorAll('details.section').forEach(d=> d.removeAttribute('open')));
  }

  // ====== Export (JSON) ======
  function gatherExportPayload(){ 
    return { 
      meta:{ 
        project:$('#project').value.trim(), 
        who:$('#who').value.trim(), 
        when: $('#when').value || new Date().toISOString().slice(0,10) 
      }, 
      items: state.items 
    }; 
  }
  document.getElementById('exportJSON').addEventListener('click', ()=>{
    const data=gatherExportPayload(); 
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
    const name = 'feedback_'+Date.now()+'.json';
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  });

  // ====== Excel load (autoload only) ======
  async function parseWorkbook(ab){
    const wb = XLSX.read(ab, { type: 'array' });
    const sheetName = wb.SheetNames.find(n => n.toLowerCase() === 'questions') || wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: '' });
    if (!rows.length) { renderSections([]); return; }
    const groups = new Map();
    rows.forEach((r,i) => {
      const section = String(r.Section || 'Untitled').trim();
      const sorder = Number(r.SectionOrder || 0) || 0;
      const id = String(r.QuestionID || ('q_'+(i+1))).trim();
      const text = String(r.QuestionText || '').trim();
      const qorder = Number(r.QOrder || 0) || 0;
      const refA = [r.RefA1, r.RefA2].map(v => String(v||'').trim()).filter(Boolean);
      const refB = [r.RefB1, r.RefB2].map(v => String(v||'').trim()).filter(Boolean);
      if(!groups.has(section)) groups.set(section, { title: section, order: sorder, questions: [] });
      groups.get(section).questions.push({ id, text, order: qorder, refA, refB });
    });
    const sections = Array.from(groups.values())
      .sort((a,b)=>a.order-b.order)
      .map(sec => ({ title: sec.title, questions: sec.questions.sort((a,b)=>a.order-b.order).map(q => ({ id:q.id, text:q.text, refA:q.refA, refB:q.refB })) }));
    renderSections(sections);
  }

  async function loadExcelFromUrl(url){
    const res = await fetch(new URL(url, document.baseURI), { cache: 'no-store' });
    if(!res.ok) throw new Error('Failed to fetch Excel at '+url);
    const ab = await res.arrayBuffer();
    await parseWorkbook(ab);
  }

  // Meta events
  $('#project').addEventListener('input', ()=>{ state.project=$('#project').value; markDirty(); });
  $('#who').addEventListener('input', ()=>{ state.who=$('#who').value; markDirty(); });
  $('#when').addEventListener('change', ()=>{ state.when=$('#when').value; markDirty(); });

  // ====== Auto-load path ======
  const FIXED_XLSX_PATH = 'QuestionsList.xlsx';
  loadExcelFromUrl(FIXED_XLSX_PATH).catch(err => console.warn('Auto-load failed:', err));
</script>

<!-- ====== PDF Export (ASCII-only; always prints all fields) ====== -->
<script>
(function(){
  function escapeHTML(s){
    return String(s == null ? "" : s).replace(/[&<>"]/g, function(m){
      return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;" })[m];
    });
  }
  function el(tag, css){
    var n = document.createElement(tag);
    if (css) n.style.cssText = css;
    return n;
  }
  function textKV(label, value){
    var box = el("div", "display:inline-flex; gap:6px; align-items:baseline; margin-right:16px; color:#333; font:14px/1.4 system-ui;");
    var b = el("strong"); b.textContent = label; box.appendChild(b);
    var s = el("span"); s.textContent = value; box.appendChild(s);
    return box;
  }
  function countStarsFromDOM(qRoot){
    var on = qRoot.querySelectorAll(".stars .star.on").length;
    if (on) return on;
    var filled = 0;
    qRoot.querySelectorAll(".stars .star").forEach(function(btn){
      if ((btn.textContent || "").trim() === "★") filled++;
    });
    return filled;
  }
  function collectPhotoSrcs(qRoot, qid){
    var arr = [];
    try {
      if (window.state && state.items && state.items[qid] && Array.isArray(state.items[qid].photos)) {
        state.items[qid].photos.forEach(function(p){ if (p && p.dataUrl) arr.push(p.dataUrl); });
        if (arr.length) return arr;
      }
    } catch(e){}
    qRoot.querySelectorAll('[data-role="userPhotos"] img').forEach(function(img){
      if (img && img.src) arr.push(img.src);
    });
    return arr;
  }
  function buildSimplifiedPdfEl(){
    var root = el("div", "width:800px; padding:24px; background:#fff; color:#111; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;");
    var metaWrap = el("header", "border-bottom:1px solid #e5e7eb; margin-bottom:12px; padding-bottom:8px;");
    var h1 = el("h1", "margin:0 0 6px; font:700 20px/1.2 system-ui;"); h1.textContent = "Survey Responses";
    metaWrap.appendChild(h1);
    var project = (document.querySelector("#meta #project")||{}).value || "";
    var when    = (document.querySelector("#meta #when")||{}).value || new Date().toISOString().slice(0,10);
    var who     = (document.querySelector("#meta #who")||{}).value || "";
    var row = el("div", "display:flex; flex-wrap:wrap; align-items:center;");
    row.appendChild(textKV("Project #:", project));
    row.appendChild(textKV("Date:", when));
    row.appendChild(textKV("Surveyor:", who));
    metaWrap.appendChild(row);
    root.appendChild(metaWrap);

    var sections = document.querySelectorAll("#sections details.section, details.section");
    sections.forEach(function(sec){
      var sum = sec.querySelector("summary");
      var title = sum ? (sum.textContent || "").trim() : "";
      if (title){
        var h2 = el("h2", "font:600 16px/1.3 system-ui; margin:8px 0 6px;");
        h2.textContent = title;
        root.appendChild(h2);
      }
      var qs = sec.querySelectorAll(".q");
      qs.forEach(function(q){
        var qid = q.dataset ? (q.dataset.id || "") : "";
        var qtextEl = q.querySelector("h2, h3");
        var qtext = qtextEl ? (qtextEl.textContent || "").trim() : "";

        var rating = 0;
        try { rating = Number((state.items && state.items[qid] && state.items[qid].rating) || 0); } catch(e){}
        if (!rating) rating = countStarsFromDOM(q);

        var comment = "";
        try { comment = (state.items && state.items[qid] && state.items[qid].comment) || ""; } catch(e){}
        if (!comment) { var ta = q.querySelector("textarea"); comment = ta ? (ta.value || "") : ""; }

        var photoSrcs = collectPhotoSrcs(q, qid);

        var card = el("div", "border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin:8px 0; page-break-inside:avoid;");
        var titleLine = el("div", "font:600 14px/1.3 system-ui; margin:0 0 6px;"); titleLine.textContent = qtext; card.appendChild(titleLine);

        var ratingLine = el("div", "font:14px/1.4 system-ui; color:#333; margin:0 6px 6px 0;");
        ratingLine.innerHTML = "<strong>Rating:</strong> " + (rating ? (rating + "/5") : "N/A");
        card.appendChild(ratingLine);

        var commentLine = el("div", "font:14px/1.4 system-ui; color:#333; margin:0 6px 8px 0;");
        commentLine.innerHTML = "<strong>Comments:</strong> " + (String(comment).trim() ? escapeHTML(comment) : "N/A");
        card.appendChild(commentLine);

        if (photoSrcs.length){
          var grid = el("div", "display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px;");
          photoSrcs.forEach(function(src){
            var img = document.createElement("img");
            img.src = src; img.alt = "photo";
            img.style.cssText = "width:100%; height:170px; object-fit:cover; border:1px solid #ddd; border-radius:8px;";
            grid.appendChild(img);
          });
          card.appendChild(grid);
        } else {
          var none = el("div", "font:14px/1.4 system-ui; color:#333;");
          none.textContent = "Photos: (none)";
          card.appendChild(none);
        }
        root.appendChild(card);
      });
    });

    return root;
  }
  function exportPDF(){
    var el = buildSimplifiedPdfEl();
    document.body.appendChild(el);

    var proj = ((document.querySelector("#meta #project")||{}).value || "project").trim().replace(/\s+/g,"_");
    var when = (document.querySelector("#meta #when")||{}).value || new Date().toISOString().slice(0,10);
    var filename = "survey_" + proj + "_" + when + ".pdf";

    var opt = {
      margin: 0.5,
      filename: filename,
      image: { type: "jpeg", quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
    };

    html2pdf().set(opt).from(el).save()
      .then(function(){ el.remove(); })
      .catch(function(){ el.remove(); });
  }
  var btn = document.getElementById("exportPDF");
  if (btn) btn.addEventListener("click", exportPDF);
})();
</script>
</body>
</html>
