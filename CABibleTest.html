<script id="pdf-export">
  // PDF export: question + user inputs only (always print fields)
  function escapeHTML(s) {
    return String(s ?? "").replace(/[&<>"]/g, m => (
      { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[m]
    ));
  }

  // Build a clean, standalone report element from current state + DOM
  function buildSimplifiedPdfEl() {
    // Meta
    const meta = {
      project: (document.querySelector('#meta #project')?.value || '').trim(),
      when: document.querySelector('#meta #when')?.value || new Date().toISOString().slice(0,10),
      who: (document.querySelector('#meta #who')?.value || '').trim(),
    };

    const root = document.createElement('div');
    root.style.cssText = 'width:800px; padding:24px; background:#fff; color:#111; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;';

    root.innerHTML = `
      <header style="border-bottom:1px solid #e5e7eb; margin-bottom:12px; padding-bottom:8px;">
        <h1 style="margin:0 0 6px; font:700 20px/1.2 system-ui;">Survey Responses</h1>
        <div style="display:flex; gap:16px; flex-wrap:wrap; color:#333; font:14px/1.4 system-ui;">
          <div><strong>Project #:</strong> ${escapeHTML(meta.project)}</div>
          <div><strong>Date:</strong> ${escapeHTML(meta.when)}</div>
          <div><strong>Surveyor:</strong> ${escapeHTML(meta.who)}</div>
        </div>
      </header>
    `;

    // Sections
    const sections = document.querySelectorAll('#sections details.section');
    sections.forEach(sec => {
      const title = sec.querySelector('summary')?.textContent?.trim() || '';
      if (title) {
        const h2 = document.createElement('h2');
        h2.textContent = title;
        h2.style.cssText = 'font:600 16px/1.3 system-ui; margin:8px 0 6px;';
        root.appendChild(h2);
      }

      // Questions
      const qs = sec.querySelectorAll('.q');
      qs.forEach(q => {
        const qid = q.dataset.id || '';
        const qtext = q.querySelector('h2, h3')?.textContent?.trim() || '';

        // Pull user inputs from state if available (fallback to DOM)
        const it = (window.state && window.state.items && window.state.items[qid]) || {};
        const rating = Number(it.rating || 0);
        const comment = (it.comment ?? q.querySelector('textarea')?.value ?? '').trim();
        const photos = Array.isArray(it.photos) ? it.photos : [];

        const qdiv = document.createElement('div');
        qdiv.style.cssText = 'border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin:8px 0; page-break-inside: avoid;';
        qdiv.innerHTML = `
          <div style="font:600 14px/1.3 system-ui; margin:0 0 6px;">${escapeHTML(qtext)}</div>
          <div style="font:14px/1.4 system-ui; color:#333; margin:0 6px 6px 0;"><strong>Rating:</strong> ${rating ? `${rating}/5` : '—'}</div>
          <div style="font:14px/1.4 system-ui; color:#333; margin:0 6px 8px 0;"><strong>Comments:</strong> ${comment ? escapeHTML(comment) : '—'}</div>
        `;

        // Photos: always include a section; show grid or "(none)"
        if (photos.length) {
          const grid = document.createElement('div');
          grid.style.cssText = 'display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;';
          photos.forEach(p => {
            const img = document.createElement('img');
            img.src = p.dataUrl;
            img.alt = 'photo';
            img.style.cssText = 'width:100%; height:170px; object-fit:cover; border:1px solid #ddd; border-radius:8px;';
            grid.appendChild(img);
          });
          qdiv.appendChild(grid);
        } else {
          const none = document.createElement('div');
          none.textContent = 'Photos: (none)';
          none.style.cssText = 'font:14px/1.4 system-ui; color:#333;';
          qdiv.appendChild(none);
        }

        root.appendChild(qdiv);
      });
    });

    return root;
  }

  function exportPDF() {
    const el = buildSimplifiedPdfEl();
    document.body.appendChild(el);

    const proj = (document.querySelector('#meta #project')?.value || 'project').trim().replace(/\s+/g,'_');
    const when = document.querySelector('#meta #when')?.value || new Date().toISOString().slice(0,10);
    const filename = `survey_${proj}_${when}.pdf`;

    const opt = {
      margin: 0.5,
      filename,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(el).save()
      .then(() => el.remove())
      .catch(() => el.remove());
  }

  document.getElementById('exportPDF')?.addEventListener('click', exportPDF);
</script>
