<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DBR Studio — Home</title>
  <link rel="stylesheet" href="assets/style.css?v=2025-10-01-2"/>
</head>
<body>
  <main>
    <header>
      <h1><a href="index.html" style="text-decoration:none;color:inherit">DBR Studio</a></h1>
      <p>Photos • Art • Music — by our members</p>
      <nav>
        <a href="index.html">Home</a>
        <a href="submit.html">Submit</a>
      </nav>
      <hr/>
    </header>

    <div class="toolbar">
      <select id="category" class="select">
        <option value="">All categories</option>
      </select>
      <input id="search" class="input" placeholder="Search title, author, caption…"/>
      <button id="clear" class="button ghost">Clear</button>
    </div>

    <section id="feed" class="grid" aria-live="polite"></section>

    <!-- Card template -->
    <template id="card">
      <article class="card">
        <a class="image-link" href="#"><img class="img" alt=""/></a>
        <div class="pad">
          <h3><a class="title" href="#"></a></h3>
          <div class="meta"></div>
          <p class="caption"></p>
          <div class="badge-row"></div>
          <div class="tags"></div>
        </div>
      </article>
    </template>
  </main>

  <script>
    const FEED = document.getElementById('feed');
    const TPL  = document.getElementById('card');
    const src  = 'data/posts.json?v=' + Date.now();
    const sel  = document.getElementById('category');
    const q    = document.getElementById('search');
    const clear= document.getElementById('clear');
    let ALL = [];

    const fmtDate = iso => {
      try { return new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
      catch { return iso||''; }
    };

    function buildCats(posts){
      const set = new Set();
      for (const p of posts) if (p.category) set.add(p.category);
      const opts = [...set].sort();
      for (const c of opts){
        const o = document.createElement('option');
        o.value = c; o.textContent = c; sel.appendChild(o);
      }
    }

    function ytIdFrom(url){
      try{
        if (url.includes('watch?v=')) return url.split('watch?v=')[1].split('&')[0];
        if (url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0];
      }catch(e){}
      return null;
    }

    function render(list){
      FEED.replaceChildren();
      if (!list.length){ FEED.textContent='No posts match.'; return; }

      for (const p of list){
        const node  = TPL.content.cloneNode(true);
        const title = p.title || 'Untitled';
        const link  = 'post.html?id=' + encodeURIComponent(p.id);

        // Title
        const titleA = node.querySelector('.title');
        titleA.textContent = title;
        titleA.href = link;

        // Image (normal, or YouTube thumbnail fallback)
        const imgWrap = node.querySelector('.image-link');
        const imgEl   = node.querySelector('.img');
        let showedImg = false;

        if (p.image && String(p.image).trim() !== ''){
          imgEl.src = p.image; imgEl.alt = title; imgWrap.href = link;
          showedImg = true;
        } else if (p.link){
          const id = ytIdFrom(String(p.link));
          if (id){
            imgEl.src = 'https://img.youtube.com/vi/' + id + '/hqdefault.jpg';
            imgEl.alt = title + ' (YouTube)';
            imgWrap.href = link;
            showedImg = true;
          }
        }
        if (!showedImg){ imgWrap.remove(); }

        // Meta
        node.querySelector('.meta').textContent =
          [p.author, fmtDate(p.date), p.category].filter(Boolean).join(' · ');

        // Caption
        const cap = node.querySelector('.caption');
        if (p.caption && String(p.caption).trim() !== '') cap.textContent = p.caption;
        else cap.remove();

        // Badge row for links
        const badgeRow = node.querySelector('.badge-row');
        if (p.link && String(p.link).trim() !== ''){
          const url = p.link.trim();
          const a = document.createElement('a');
          a.className = 'badge';
          a.target = '_blank'; a.rel = 'noopener';
          a.href = url;

          if (url.includes('youtube.com') || url.includes('youtu.be')){
            a.innerHTML = '<span class="ico">▶</span><span>Watch</span>';
          } else if (url.includes('soundcloud.com')){
            a.innerHTML = '<span class="ico">♪</span><span>Listen</span>';
          } else {
            a.innerHTML = '<span class="ico">↗</span><span>Open</span>';
          }
          badgeRow.appendChild(a);
        } else {
          badgeRow.remove();
        }

        // Tags
        const tagsWrap = node.querySelector('.tags');
        if (Array.isArray(p.tags) && p.tags.length){
          for (const t of p.tags){
            const a = document.createElement('a');
            a.className='tag'; a.href='index.html#'+encodeURIComponent(t);
            a.textContent = '#'+t; tagsWrap.appendChild(a);
          }
        } else tagsWrap.remove();

        FEED.appendChild(node);
      }
    }

    function applyFilters(){
      const cat = sel.value.trim().toLowerCase();
      const term= q.value.trim().toLowerCase();
      const list = ALL.filter(p=>{
        const byCat = !cat || (p.category||'').toLowerCase()===cat;
        if (!byCat) return false;
        if (!term) return true;
        const hay = [p.title,p.author,p.caption,(p.tags||[]).join(' ')].join(' ').toLowerCase();
        return hay.includes(term);
      });
      render(list);
    }

    fetch(src).then(r=>{
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(data=>{
      ALL = (data.posts||[]).slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
      buildCats(ALL);
      render(ALL);
    }).catch(err=>{
      FEED.textContent='Failed to load posts.json — check the path and JSON syntax.'; console.error(err);
    });

    sel.addEventListener('change', applyFilters);
    q.addEventListener('input', applyFilters);
    clear.addEventListener('click', e=>{ e.preventDefault(); sel.value=''; q.value=''; render(ALL); });
  </script>
</body>
</html>
