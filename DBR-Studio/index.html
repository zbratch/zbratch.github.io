<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DBR Studio</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
</head>
<body>
  <nav>
    <div class="nav-inner">
      <a class="brand" href="./"><span class="logo"></span> DBR Studio</a>
      <div class="links">
        <a href="./music.html">Music</a>
        <a href="./photography.html">Photography</a>
        <a href="./art.html">Art</a>
        <a href="./CONTRIBUTING.html">Contribute</a>
      </div>
    </div>
  </nav>

  <header class="hero container">
    <h1>Make, share, and vibe.</h1>
    <p>DBR Studio is our creative clubhouse for <strong>music</strong>, <strong>photography</strong>, and <strong>art</strong>. Post playlists, pic-of-the-day, polls, and your own creations—kindly and responsibly.</p>
    <div class="flex" style="margin-top:16px">
      <a class="btn" href="./music.html">Start with Music</a>
      <a class="btn ghost" href="./photography.html">See Photos</a>
      <a class="btn ghost" href="./art.html">Share Art</a>
    </div>
  </header>

  <main class="container">
    <section aria-labelledby="latest-heading">
      <h2 id="latest-heading" class="section-title">Latest from the Club</h2>
      <div id="latest">
        <noscript><p class="muted">Enable JavaScript to view posts.</p></noscript>
      </div>
    </section>

    <section aria-labelledby="sections-heading">
      <h2 id="sections-heading" class="section-title">Sections</h2>
      <div class="grid">
        <div class="card">
          <span class="badge">Music</span>
          <h3>DBR Music</h3>
          <p>Blog, playlists, community polls, and space for DBR musicians to share.</p>
          <a class="btn" href="./music.html">Open</a>
        </div>
        <div class="card">
          <span class="badge">Photography</span>
          <h3>DBR Photography</h3>
          <p>Pic of the Day, favorites, and photo blog.</p>
          <a class="btn" href="./photography.html">Open</a>
        </div>
        <div class="card">
          <span class="badge">Art</span>
          <h3>DBR Art</h3>
          <p>Post your art and browse what others are making.</p>
          <a class="btn" href="./art.html">Open</a>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">© 2025 DBR Studio — Built for GitHub Pages</footer>

  <!-- Inline renderer: Title, Desc, Images, Embed, "Submitted by X on Y" -->
  <script>
    async function getPosts() {
      const res = await fetch('./posts/posts.json?_=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load posts.json: ' + res.status);
      return res.json();
    }

    function fmtDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
    }

    function escapeHTML(s='') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function renderPost(p) {
      const title = escapeHTML(p.title || 'Untitled');
      const summary = p.summary ? `<p class="summary">${escapeHTML(p.summary)}</p>` : '';

      // IMAGES (all of them, before embed)
      let imagesHTML = '';
      if (Array.isArray(p.images) && p.images.length) {
        imagesHTML = `
          <div class="images">
            ${p.images.map(u => `<img src="${u}" alt="${title}" loading="lazy">`).join('')}
          </div>`;
      } else if (p.image) {
        imagesHTML = `<div class="images"><img src="${p.image}" alt="${title}"></div>`;
      }

      // EMBED (after images, if present)
      const embedHTML = p.embed ? `<div class="embed">${p.embed}</div>` : (p.link ? `<p class="ext"><a href="${p.link}" target="_blank" rel="noopener">Open link →</a></p>` : '');

      // CAPTION LINE
      const dateStr = fmtDate(p.date || '');
      const who = p.caption ? escapeHTML(p.caption.replace(/^Submitted by\s*/i, '').trim()) : '';
      const captionLine = (who || dateStr)
        ? `<p class="meta">Submitted by ${who || 'Anonymous'}${dateStr ? ' on ' + dateStr : ''}</p>`
        : '';

      return `
        <article class="card post">
          <div class="content">
            <h3 class="title">${title}</h3>
            ${summary}
            ${imagesHTML}
            ${embedHTML}
            ${captionLine}
          </div>
        </article>
      `;
    }

    async function boot() {
      const mount = document.getElementById('latest');
      try {
        const posts = await getPosts();
        if (!Array.isArray(posts) || posts.length === 0) {
          mount.innerHTML = `<p class="muted">No posts yet.</p>`;
          return;
        }
        // Latest 12
        const html = posts.slice(0, 12).map(renderPost).join('');
        mount.innerHTML = html;
      } catch (e) {
        console.error(e);
        mount.innerHTML = `<div class="error">Could not load posts.</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
